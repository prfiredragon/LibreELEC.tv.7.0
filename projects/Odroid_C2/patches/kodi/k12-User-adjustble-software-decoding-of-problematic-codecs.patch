From c9b395b5acef9d8226b0274e5adffea54da931be Mon Sep 17 00:00:00 2001
From: Jamie Coldhill <wrxtasy@amnet.net.au>
Date: Mon, 8 Aug 2016 14:02:31 +0800
Subject: [PATCH] User adjustble software decoding of problematic mpeg2 / mpeg4
 / H264 codecs

---
 .../resource.language.en_gb/resources/strings.po   | 36 ++++++++++++++++++-
 system/settings/settings.xml                       | 41 ++++++++++++++++++++++
 xbmc/cores/dvdplayer/DVDCodecs/DVDFactoryCodec.cpp | 20 ++++++++---
 xbmc/settings/Settings.cpp                         |  3 ++
 xbmc/settings/Settings.h                           |  3 ++
 5 files changed, 97 insertions(+), 6 deletions(-)

diff --git a/addons/resource.language.en_gb/resources/strings.po b/addons/resource.language.en_gb/resources/strings.po
index a697a61..5741cf8 100644
--- a/addons/resource.language.en_gb/resources/strings.po
+++ b/addons/resource.language.en_gb/resources/strings.po
@@ -6709,7 +6709,25 @@ msgctxt "#13557"
 msgid "Skip delay"
 msgstr ""
 
-#empty strings from id 13558 to 13599
+#. Description of setting "Videos -> Playback -> Adjust hardware acceleration (amcodec)- mpeg2" with label #39001
+#: system/settings/settings.xml
+msgctxt "#13558"
+msgid "Adjustable mpeg2 software decoding for problematic files"
+msgstr ""
+
+#. Description of setting "Videos -> Playback -> Adjust hardware acceleration (amcodec)- mpeg2 / Xvid" with label #39002
+#: system/settings/settings.xml
+msgctxt "#13559"
+msgid "Adjustable mpeg4 / Xvid software decoding for problematic files"
+msgstr ""
+
+#. Description of setting "Videos -> Playback -> Adjust hardware acceleration (amcodec)- H264" with label #39003
+#: system/settings/settings.xml
+msgctxt "#13560"
+msgid "Adjustable H264 software decoding for problematic files"
+msgstr ""
+
+#empty strings from id 13561 to 13599
 
 #: system/settings/darwin.xml
 msgctxt "#13600"
@@ -18110,3 +18128,19 @@ msgstr ""
 msgctxt "#38023"
 msgid "Set my rating"
 msgstr ""
+
+msgctxt "#39000"
+msgid "720p and up"
+msgstr ""
+
+msgctxt "#39001"
+msgid "Accelerate MPEG2"
+msgstr ""
+
+msgctxt "#39002"
+msgid "Accelerate MPEG4"
+msgstr ""
+
+msgctxt "#39003"
+msgid "Accelerate H264"
+msgstr ""
diff --git a/system/settings/settings.xml b/system/settings/settings.xml
index 76c9a33..0d23ebc 100644
--- a/system/settings/settings.xml
+++ b/system/settings/settings.xml
@@ -835,6 +835,47 @@
           <control type="toggle" />
         </setting>
       </group>
+      <group id="4">
+       <setting id="videoplayer.accelmpeg2" type="integer" label="39001" help="13558">
+         <level>2</level>
+         <default>0</default>
+         <constraints>
+           <options>
+           <option label="20420">9999</option>   <!-- Never -->
+           <option label="39000">800</option>  <!-- HD -->
+           <option label="20422">0</option>  <!-- Always -->
+           </options>
+         </constraints>
+         <control type="spinner" format="string" />
+         <control type="edit" format="integer" />
+       </setting>
+       <setting id="videoplayer.accelmpeg4" type="integer" label="39002" help="13559">
+         <level>2</level>
+         <default>800</default>
+         <constraints>
+           <options>
+           <option label="20420">9999</option>   <!-- Never -->
+           <option label="39000">800</option>  <!-- HD -->
+           <option label="20422">0</option>  <!-- Always -->
+           </options>
+         </constraints>
+         <control type="spinner" format="string" />
+         <control type="edit" format="integer" />
+       </setting>
+       <setting id="videoplayer.accelh264" type="integer" label="39003" help="13560">
+         <level>2</level>
+         <default>0</default>
+         <constraints>
+           <options>
+           <option label="20420">9999</option>   <!-- Never -->
+           <option label="39000">800</option>  <!-- HD -->
+           <option label="20422">0</option>  <!-- Always -->
+           </options>
+         </constraints>
+         <control type="spinner" format="string" />
+         <control type="edit" format="integer" />
+       </setting>
+      </group>
     </category>
     <category id="myvideos" label="14081" help="36601">
       <group id="1">
diff --git a/xbmc/cores/dvdplayer/DVDCodecs/DVDFactoryCodec.cpp b/xbmc/cores/dvdplayer/DVDCodecs/DVDFactoryCodec.cpp
index 84e9ef1..451e80f 100644
--- a/xbmc/cores/dvdplayer/DVDCodecs/DVDFactoryCodec.cpp
+++ b/xbmc/cores/dvdplayer/DVDCodecs/DVDFactoryCodec.cpp
@@ -208,7 +208,9 @@ CDVDVideoCodec* CDVDFactoryCodec::CreateVideoCodec(CDVDStreamInfo &hint, const C
   }
 
 #if defined(HAS_LIBAMCODEC)
-  // amcodec can handle dvd playback.
+  // amcodec has issues with some mpeg4 / XVid files
+  // and also has issues with 480/576i DVD mpeg2 Hardware deinterlacing
+  // there are also problems with 480/576i H264 TV aspect ratio, allow user to software decode these.
   if (!hint.software && CSettings::GetInstance().GetBool(CSettings::SETTING_VIDEOPLAYER_USEAMCODEC))
   {
     switch(hint.codec)
@@ -216,10 +218,18 @@ CDVDVideoCodec* CDVDFactoryCodec::CreateVideoCodec(CDVDStreamInfo &hint, const C
       case AV_CODEC_ID_MPEG4:
       case AV_CODEC_ID_MSMPEG4V2:
       case AV_CODEC_ID_MSMPEG4V3:
-        // Avoid h/w decoder for SD; Those files might use features
-        // not supported and can easily be soft-decoded
-        if (hint.width <= 800)
-          break;
+        if (hint.width > CSettings::GetInstance().GetInt(CSettings::SETTING_VIDEOPLAYER_ACCELMPEG4))
+          if ( (pCodec = OpenCodec(new CDVDVideoCodecAmlogic(), hint, options)) ) return pCodec;
+        break;
+      case AV_CODEC_ID_MPEG1VIDEO:
+      case AV_CODEC_ID_MPEG2VIDEO:
+        if (hint.width >CSettings::GetInstance().GetInt(CSettings::SETTING_VIDEOPLAYER_ACCELMPEG2))
+          if ( (pCodec = OpenCodec(new CDVDVideoCodecAmlogic(), hint, options)) ) return pCodec;
+        break;
+      case AV_CODEC_ID_H264:
+        if (hint.width >CSettings::GetInstance().GetInt(CSettings::SETTING_VIDEOPLAYER_ACCELH264))
+          if ( (pCodec = OpenCodec(new CDVDVideoCodecAmlogic(), hint, options)) ) return pCodec;
+        break;
       default:
         if ( (pCodec = OpenCodec(new CDVDVideoCodecAmlogic(), hint, options)) ) return pCodec;
     }
diff --git a/xbmc/settings/Settings.cpp b/xbmc/settings/Settings.cpp
index f50355b..583deab 100644
--- a/xbmc/settings/Settings.cpp
+++ b/xbmc/settings/Settings.cpp
@@ -180,6 +180,9 @@ const std::string CSettings::SETTING_VIDEOPLAYER_USEVIDEOTOOLBOX = "videoplayer.
 const std::string CSettings::SETTING_VIDEOPLAYER_USEVDA = "videoplayer.usevda";
 const std::string CSettings::SETTING_VIDEOPLAYER_USEMMAL = "videoplayer.usemmal";
 const std::string CSettings::SETTING_VIDEOPLAYER_USESTAGEFRIGHT = "videoplayer.usestagefright";
+const std::string CSettings::SETTING_VIDEOPLAYER_ACCELMPEG2 = "videoplayer.accelmpeg2";
+const std::string CSettings::SETTING_VIDEOPLAYER_ACCELMPEG4 = "videoplayer.accelmpeg4";
+const std::string CSettings::SETTING_VIDEOPLAYER_ACCELH264 = "videoplayer.accelh264";
 const std::string CSettings::SETTING_VIDEOPLAYER_LIMITGUIUPDATE = "videoplayer.limitguiupdate";
 const std::string CSettings::SETTING_MYVIDEOS_SELECTACTION = "myvideos.selectaction";
 const std::string CSettings::SETTING_MYVIDEOS_EXTRACTFLAGS = "myvideos.extractflags";
diff --git a/xbmc/settings/Settings.h b/xbmc/settings/Settings.h
index 55e150d..1fbc6cf 100644
--- a/xbmc/settings/Settings.h
+++ b/xbmc/settings/Settings.h
@@ -136,6 +136,9 @@ public:
   static const std::string SETTING_VIDEOPLAYER_USEVDA;
   static const std::string SETTING_VIDEOPLAYER_USEMMAL;
   static const std::string SETTING_VIDEOPLAYER_USESTAGEFRIGHT;
+  static const std::string SETTING_VIDEOPLAYER_ACCELMPEG2;
+  static const std::string SETTING_VIDEOPLAYER_ACCELMPEG4;
+  static const std::string SETTING_VIDEOPLAYER_ACCELH264;
   static const std::string SETTING_VIDEOPLAYER_LIMITGUIUPDATE;
   static const std::string SETTING_MYVIDEOS_SELECTACTION;
   static const std::string SETTING_MYVIDEOS_EXTRACTFLAGS;
-- 
1.9.1

